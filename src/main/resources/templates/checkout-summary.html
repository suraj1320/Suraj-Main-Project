<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/head :: head}"></head>

<body>

    <header th:replace="~{fragments/header :: header}"></header>

    <div class="container" style="padding-top: 120px; max-width: 900px;">
        <h2 class="section-title">ORDER SUMMARY</h2>

        <div class="grid" style="grid-template-columns: 1.5fr 1fr; gap: 2rem;">

            <div class="glass-panel" style="padding: 2rem;">
                <h3 style="margin-bottom: 1.5rem; color: var(--accent-color);">Review Items</h3>
                <div id="summary-items"></div>

                <h3 style="margin-top: 2rem; margin-bottom: 1rem; color: var(--accent-color);">Shipping To</h3>
                <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 10px;">
                    <p th:text="${address.street}"></p>
                    <p th:text="${address.city + ', ' + address.state + ' ' + address.zipCode}"></p>
                </div>
            </div>

            <div class="glass-panel" style="padding: 2rem; height: fit-content;">
                <h3 style="margin-bottom: 1.5rem; color: var(--accent-color);">Total</h3>
                <div
                    style="display: flex; justify-content: space-between; font-size: 1.5rem; font-weight: bold; margin-bottom: 2rem;">
                    <span>Total Amount</span>
                    <span id="summary-total">$0.00</span>
                </div>

                <form th:action="@{/checkout/place-order}" method="post" id="place-order-form">
                    <input type="hidden" name="addressId" th:value="${address.id}">
                    <input type="hidden" name="cartJson" id="cart-json">

                    <button type="submit" class="btn-primary" style="width: 100%;">Place Order</button>
                </form>
                <p style="text-align: center; font-size: 0.8rem; margin-top: 10px; color: #7f8c8d;">
                    By clicking above, you agree to our Terms of Service.
                </p>
            </div>

        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const cart = JSON.parse(localStorage.getItem('saga_cart')) || [];
            if (cart.length === 0) {
                window.location.href = '/shop';
                return;
            }

            const container = document.getElementById('summary-items');
            let total = 0;

            cart.forEach(item => {
                const qty = item.quantity || 1;
                const price = parseFloat(item.price);
                total += price * qty;

                const div = document.createElement('div');
                div.style.marginBottom = '1rem';
                div.style.paddingBottom = '1rem';
                div.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                div.innerHTML = `
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <img src="${item.image || '/images/placeholder.jpg'}" style="width: 50px; height: 75px; object-fit: cover; border-radius: 5px;">
                        <div style="flex-grow: 1;">
                            <div style="display: flex; justify-content: space-between; font-weight: bold;">
                                <span>${item.title}</span>
                                <span>$${(price * qty).toFixed(2)}</span>
                            </div>
                            <div style="font-size: 0.9rem; color: #bdc3c7;">
                                Qty: ${qty} x $${price.toFixed(2)}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });

            document.getElementById('summary-total').textContent = '$' + total.toFixed(2);
            document.getElementById('cart-json').value = JSON.stringify(cart);

            // On submit, maybe clear cart? 
            // Better to clear cart on success page to avoid clearing on failed submission.
        });
    </script>

    <footer th:replace="~{fragments/footer :: footer}"></footer>
</body>

</html>